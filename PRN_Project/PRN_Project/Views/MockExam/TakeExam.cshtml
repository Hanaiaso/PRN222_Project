@model PRN_Project.Models.Exam

@{
    var duration = (int)Math.Floor((Model.EndTime - DateTime.Now)?.TotalSeconds ?? 0);
}

<h2>📝 Bài thi: @Model.EName</h2>

<div class="alert alert-info">
    <strong>Thời gian còn lại: </strong> <span id="timer"></span>
</div>

<form id="examForm" method="post" asp-action="SubmitExam" asp-controller="MockExam">
    <input type="hidden" name="examId" value="@Model.EId" />

    @for (int i = 0; i < Model.Questions!.Count; i++)
    {
        var q = Model.Questions[i];
        <div class="card mb-3 p-3">
            <h5>Câu @(@i + 1): @q.Question</h5>
            @foreach (var opt in q.Options)
            {
                <div>
                    <input type="radio" name="answers[@i].ChosenAnswer" value="@opt" />
                    <label>@opt</label>
                </div>
            }
            <input type="hidden" name="answers[@i].QuestionIndex" value="@i" />
        </div>
    }

    <button type="submit" class="btn btn-primary">Nộp bài</button>
</form>

<script>
    let timeLeft = @duration;
    const timerDisplay = document.getElementById("timer");
    let formSubmitted = false;

    // 🕒 Bộ đếm ngược
    function updateTimer() {
        if (formSubmitted) return;
        // Tính toán phút và giây còn lại
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        const formattedSeconds = seconds.toString().padStart(2, '0');
        const formattedMinutes = minutes.toString().padStart(2, '0');
        timerDisplay.innerText = `${formattedMinutes} phút ${formattedSeconds} giây`;
        timeLeft--;

        if (timeLeft < 0) {
            autoSubmit("⏰ Hết thời gian làm bài. Hệ thống tự động nộp.");
        } else {
            setTimeout(updateTimer, 1000);
        }
    }
    updateTimer();

    // ✅ Hàm nộp bài (chỉ chạy 1 lần)
    function autoSubmit(reason = "") {
        if (formSubmitted) return;
        formSubmitted = true;
        sessionStorage.setItem("exam_submitted_@Model.EId", "true");

        if (reason) alert(reason);

        const form = document.getElementById("examForm");
        const formData = new FormData(form);

        try {
            // Gửi dữ liệu an toàn ngay cả khi reload/đóng trang
            navigator.sendBeacon(form.action, new URLSearchParams(formData));
        } catch (e) {
            // Fallback cho trình duyệt cũ
            form.submit();
        }
    }

    // Khi người dùng nộp thủ công
    document.getElementById("examForm").addEventListener("submit", () => {
        formSubmitted = true;
        sessionStorage.setItem("exam_submitted_@Model.EId", "true");
    });

    // ⚠️ Cảnh báo khi người dùng rời khỏi trang (bao gồm reload hoặc back)
    window.addEventListener("beforeunload", (e) => {
        if (!formSubmitted) {
            autoSubmit("⚠️ Bạn vừa rời khỏi trang thi. Bài thi đã được tự động nộp.");
            e.preventDefault();
            e.returnValue = "";
        }
    });

    // 🚫 Ngăn quay lại sau khi đã nộp
    window.addEventListener("pageshow", () => {
        if (sessionStorage.getItem("exam_submitted_@Model.EId") === "true") {
            alert("❌ Bạn đã nộp bài thi này. Không thể quay lại.");
            window.location.href = "/Student/Dashboard";
        }
    });

    // 🚨 Theo dõi hành vi gian lận khi chuyển tab
    let tabSwitchCount = 0;
    document.addEventListener("visibilitychange", () => {
        if (document.hidden && !formSubmitted) {
            tabSwitchCount++;
            if (tabSwitchCount === 1) {
                alert("⚠️ Bạn vừa rời khỏi tab làm bài. Nếu tiếp tục, hệ thống sẽ tự động nộp.");
            } else if (tabSwitchCount > 1) {
                autoSubmit("🚨 Phát hiện gian lận: Bạn đã rời khỏi tab nhiều lần. Bài thi bị tự động nộp.");
            }
        }
    });

    // 🧱 Phát hiện mở nhiều tab cùng bài thi
    const tabId = Date.now().toString();
    localStorage.setItem("currentExamTab_@Model.EId", tabId);

    window.addEventListener("storage", (event) => {
        if (event.key === "currentExamTab_@Model.EId" && event.newValue !== tabId && !formSubmitted) {
            autoSubmit("🚨 Phát hiện mở nhiều tab cùng lúc. Bài thi bị tự động nộp.");
        }
    });
</script>
