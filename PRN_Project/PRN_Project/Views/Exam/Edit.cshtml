@using System.Text.Json
@model PRN_Project.Models.Exam
@using System.Security.Claims

@{
    ViewData["Title"] = "Sửa bài thi";
    // var role = Context.Session.GetString("role");
    var role = User.FindFirstValue(ClaimTypes.Role);

    if (role == "Admin")
    {
        Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    }
    else if (role == "Teacher")
    {
        Layout = "~/Views/Shared/_LayoutTeacher.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_LayoutStudent.cshtml";
    }
}

<h2 class="mb-4">Sửa bài thi</h2>

<form asp-action="Edit">
    <input type="hidden" asp-for="EId" />

    <div class="mb-3">
        <label asp-for="EName" class="form-label">Tên bài thi</label>
        <input asp-for="EName" class="form-control" />
        <span asp-validation-for="EName" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="SuId" class="form-label">Môn học</label>
        <select asp-for="SuId" class="form-select" asp-items="ViewBag.SubjectId">
            <option value="">-- Chọn môn học --</option>
        </select>
        <span asp-validation-for="SuId" class="text-danger"></span>
    </div>

    <div class="row mb-3">
        <div class="col">
            <label asp-for="StartTime">Thời gian bắt đầu</label>
            <input asp-for="StartTime" type="datetime-local" class="form-control" />
        </div>
        <div class="col">
            <label asp-for="EndTime">Thời gian kết thúc</label>
            <input asp-for="EndTime" type="datetime-local" class="form-control" />
        </div>
    </div>

    <hr />
    <h4>Nội dung bài thi</h4>
    <div id="questionContainer" class="mt-3">
        <!-- danh sách câu hỏi sẽ render ở đây -->
    </div>

    <button type="button" class="btn btn-success mt-2" onclick="addQuestion()">+ Thêm câu hỏi</button>

    <hr />
    <input type="hidden" name="questionData" id="questionData" />

    <div class="mt-4">
        <button type="submit" class="btn btn-primary">Lưu</button>
        <a asp-action="Index" class="btn btn-secondary">Quay lại</a>
    </div>
</form>

<script>
    let questions = @Html.Raw(JsonSerializer.Serialize(Model.Questions ?? new List<PRN_Project.Models.JsonModels.QuestionModel>()));

    function renderQuestions() {
        const container = document.getElementById('questionContainer');
        container.innerHTML = '';

        questions.forEach((q, index) => {
            const html = `
            <div class="card mb-3 p-3">
                <div class="d-flex justify-content-between">
                    <h5>Câu hỏi ${index + 1}</h5>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(${index})">Xóa</button>
                </div>
                <input type="text" class="form-control mb-2" placeholder="Nhập nội dung câu hỏi" value="${q.Question}" onchange="updateQuestion(${index}, 'Question', this.value)" />

                <label>Đáp án</label>
                ${q.Options.map((opt, i) => `
                    <div class="input-group mb-1">
                        <input type="text" class="form-control" value="${opt}" onchange="updateOption(${index}, ${i}, this.value)" />
                        <button class="btn btn-outline-danger" type="button" onclick="removeOption(${index}, ${i})">X</button>
                    </div>
                `).join('')}

                <button type="button" class="btn btn-outline-success btn-sm mb-2" onclick="addOption(${index})">+ Thêm lựa chọn</button>

                <div>
                    <label>Đáp án đúng</label>
                    <input type="text" class="form-control" value="${q.CorrectAnswer}" onchange="updateQuestion(${index}, 'CorrectAnswer', this.value)" />
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function addQuestion() {
        questions.push({ Question: '', Options: [], CorrectAnswer: '' });
        renderQuestions();
    }

    function removeQuestion(index) {
        questions.splice(index, 1);
        renderQuestions();
    }

    function addOption(qIndex) {
        questions[qIndex].Options.push('');
        renderQuestions();
    }

    function removeOption(qIndex, optIndex) {
        questions[qIndex].Options.splice(optIndex, 1);
        renderQuestions();
    }

    function updateQuestion(index, field, value) {
        questions[index][field] = value;
    }

    function updateOption(qIndex, optIndex, value) {
        questions[qIndex].Options[optIndex] = value;
    }

    document.querySelector("form").addEventListener("submit", function () {
        document.getElementById("questionData").value = JSON.stringify(questions);
    });

    renderQuestions();
</script>
